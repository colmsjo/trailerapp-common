<!DOCTYPE html>

<html>
<head>
  <title>EventsModel.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../../trailerapp-common/docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>EventsModel.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/* globals _  */</span>
<span class="hljs-comment">/* eslint consistent-this: ["error", "self"] */</span>
<span class="hljs-comment">/* eslint no-warning-comments: 0 */</span>

sap.ui.define([
  <span class="hljs-string">"sap/ui/model/json/JSONModel"</span>,
  <span class="hljs-string">"borealis/events/util/Common"</span>,
  <span class="hljs-string">"borealis/events/Config"</span>
], <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">JSONModel, Common, Config</span>) </span>{
<span class="hljs-meta">  "use strict"</span>;

  <span class="hljs-keyword">return</span> JSONModel.extend(<span class="hljs-string">"borealis.events.model.EventsModel"</span>, {</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h2 id="lifecycle-operations">Lifecycle operations</h2>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
    init: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">this</span>.setData({
        Events: <span class="hljs-literal">null</span>,
        EventDetails: <span class="hljs-literal">null</span>,
        EventDetailData: <span class="hljs-literal">null</span>,
        Lists: {
          EventSubReason: <span class="hljs-literal">null</span>
        },
        EventReasonList: <span class="hljs-literal">null</span>,
        EventSubReasonList: <span class="hljs-literal">null</span>,
        EventLocalReasonList: <span class="hljs-literal">null</span>,
        FilterEventDetails: <span class="hljs-literal">true</span>,
        UseMockData: Config.appConfig.useMockData,
        CntOpenAjaxCalls: <span class="hljs-number">0</span>
      });
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h2 id="events">Events</h2>

            </div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Array with top level events. Displayed in the first table</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    getEvent: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">idEvent</span>) </span>{
      <span class="hljs-keyword">var</span> aEvents = <span class="hljs-keyword">this</span>.getProperty(<span class="hljs-string">'/Events'</span>);
      <span class="hljs-keyword">var</span> oEvent = <span class="hljs-literal">null</span>;

      <span class="hljs-keyword">if</span> (aEvents) {
        oEvent = aEvents.find(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">el</span>) </span>{
          <span class="hljs-keyword">return</span> (el.idEvent === idEvent);
        });
      }

      <span class="hljs-keyword">return</span> oEvent;
    },

    loadEvents: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">idShiftData</span>) </span>{
      <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;

      <span class="hljs-keyword">var</span> params = {
        <span class="hljs-string">'Param.1'</span>: idShiftData,
        <span class="hljs-string">'Param.2'</span>: <span class="hljs-string">''</span>,
        <span class="hljs-string">'Param.3'</span>: <span class="hljs-string">''</span>,
        <span class="hljs-string">'Param.4'</span>: <span class="hljs-string">''</span>,
        <span class="hljs-string">'Param.5'</span>: <span class="hljs-string">''</span>
      };
      <span class="hljs-keyword">var</span> done = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">res</span>) </span>{
        self.setProperty(<span class="hljs-string">'/Events'</span>, res);

        <span class="hljs-keyword">if</span> (res) {
          res.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">el</span>) </span>{
            el.shiftDiff = <span class="hljs-built_in">parseInt</span>(el.shiftDiff, <span class="hljs-number">10</span>);
          });
        }

      };
      Common.xhr(<span class="hljs-string">'getEvents'</span>, <span class="hljs-string">'GET'</span>, params, done);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h2 id="events-details">Events details</h2>

            </div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Array with event details for one event. Displayed in the second table.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    getSavedDetailData: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">idEventDetail</span>) </span>{
      <span class="hljs-keyword">var</span> aDetails = <span class="hljs-keyword">this</span>.getProperty(<span class="hljs-string">'/EventDetails'</span>);
      <span class="hljs-keyword">var</span> oEventDetail = <span class="hljs-literal">null</span>;

      Common.debug(<span class="hljs-string">'getSavedDetailData'</span>, aDetails);

      <span class="hljs-keyword">if</span> (aDetails) {
        oEventDetail = aDetails.find(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">el</span>) </span>{
          <span class="hljs-keyword">return</span> (el.idEventDetail === idEventDetail);
        });
      }

      <span class="hljs-keyword">return</span> _.clone(oEventDetail);
    },

    loadEventDetails: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">idEvent</span>) </span>{
      <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;

      <span class="hljs-keyword">var</span> params = {
        <span class="hljs-string">'Param.1'</span>: idEvent
      };

      <span class="hljs-keyword">var</span> done = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">res</span>) </span>{
        self.setProperty(<span class="hljs-string">'/EventDetails'</span>, res);
        res.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">el</span>)</span>{
          el.comment = Common.rtrim(el.comment);
          el.synergyNumber = Common.rtrim(el.synergyNumber);
        });
      };

      Common.xhr(<span class="hljs-string">'getEventDetails'</span>, <span class="hljs-string">'GET'</span>, params, done);
    },

    loadEventDetails2: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">idEvent</span>) </span>{
      <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;

      <span class="hljs-keyword">var</span> params = {
        <span class="hljs-string">'Param.1'</span>: idEvent
      };

      <span class="hljs-keyword">return</span> Common.xhr2(<span class="hljs-string">'getEventDetails'</span>, <span class="hljs-string">'GET'</span>, params)
        .then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">res</span>) </span>{
          self.setProperty(<span class="hljs-string">'/EventDetails'</span>, res);
          res.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">el</span>)</span>{
            el.comment = Common.rtrim(el.comment);
            el.synergyNumber = Common.rtrim(el.synergyNumber);
          });
          <span class="hljs-keyword">return</span>;
        });
    },

    getEventDetails: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getProperty(<span class="hljs-string">'/EventDetails'</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <h2 id="event-detail-data">Event detail data</h2>

            </div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Object with event detail data. Same data as in the Event details Array
but used for display and edit in the bottom form.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    loadEventDetailData: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">idEventDetail</span>) </span>{
      <span class="hljs-keyword">var</span> oEventDetail = <span class="hljs-keyword">this</span>.getSavedDetailData(idEventDetail);
      Common.debug(<span class="hljs-string">'loadEventDetailData'</span>, idEventDetail, oEventDetail);
      <span class="hljs-keyword">this</span>.setProperty(<span class="hljs-string">'/EventDetailData'</span>, _.clone(oEventDetail));
    },

    saveEventDetailData: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">idEvent, idShiftData</span>) </span>{
      <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
      <span class="hljs-keyword">var</span> oDetailData = <span class="hljs-keyword">this</span>.getProperty(<span class="hljs-string">'/EventDetailData'</span>);

      Common.debug(<span class="hljs-string">'saveEventDetailData'</span>, oDetailData);

      <span class="hljs-keyword">var</span> params = {
        <span class="hljs-string">'Param.1'</span>: idEvent,
        <span class="hljs-string">'Param.2'</span>: (oDetailData.idEventDetail !== <span class="hljs-literal">null</span>) ? oDetailData.idEventDetail : <span class="hljs-number">-1</span>,
        <span class="hljs-string">'Param.3'</span>: (oDetailData.idEventPerShift !== <span class="hljs-literal">null</span>) ? oDetailData.idEventPerShift : <span class="hljs-number">-1</span>,
        <span class="hljs-string">'Param.4'</span>: idShiftData,
        <span class="hljs-string">'Param.5'</span>: oDetailData.timeStartISO.toISOString(),
        <span class="hljs-string">'Param.6'</span>: oDetailData.timeEndISO.toISOString(),
        <span class="hljs-string">'Param.7'</span>: oDetailData.classified,
        <span class="hljs-string">'Param.8'</span>: oDetailData.idEventReason,
        <span class="hljs-string">'Param.9'</span>: oDetailData.idEventSubReason,
        <span class="hljs-string">'Param.10'</span>: oDetailData.idEventLocalReason,
        <span class="hljs-string">'Param.11'</span>: (oDetailData.idEquipment !== <span class="hljs-literal">null</span>) ? oDetailData.idEquipment : <span class="hljs-number">-1</span>,
        <span class="hljs-string">'Param.12'</span>: oDetailData.synergyNumber,
        <span class="hljs-string">'Param.13'</span>: oDetailData.comment,
        <span class="hljs-string">'Param.14'</span>: (oDetailData.originIdEventDetail !== <span class="hljs-literal">null</span>) ? oDetailData.originIdEventDetail : <span class="hljs-number">-1</span>
      };

      Common.debug(<span class="hljs-string">'saveEventDetailData,params='</span>, params);</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>NOTE: All mii sqlQuery objects are called with GET (also insert/update)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">return</span> Common.xhr2(<span class="hljs-string">'saveEventDetailData'</span>, <span class="hljs-string">'GET'</span>, params)
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">res</span>) </span>{
        Common.log(<span class="hljs-string">'saveEventDetailData:result from ajax call:'</span>, res, idEvent);</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Update the list with event details so the changes are visible</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        self.loadEventDetails(idEvent);</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Show the updated shift quantity</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        self.loadEvents(idShiftData);</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Do do select any event
TODO: Fix this self._setInitialState();</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      });

    },

    clearEventDetailData: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
      Common.debug(<span class="hljs-string">'clearEventDetailData'</span>);

      <span class="hljs-keyword">this</span>.setEventDetailData(<span class="hljs-keyword">this</span>.createEmptyEventDetail());
    },

    setEventDetailData: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">obj</span>)</span>{
      Common.debug(<span class="hljs-string">'setEventDetailData:'</span>, obj);

      <span class="hljs-keyword">this</span>.setProperty(<span class="hljs-string">'/EventDetailData'</span>, obj);
    },

    createEmptyEventDetail: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> {
        <span class="hljs-string">"idEventDetail"</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-string">"idEvent"</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-string">"idEventPerShift"</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-string">"idShiftData"</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-string">"timeStartISO"</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-string">"timeStart"</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-string">"timeEndISO"</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-string">"timeEnd"</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-string">"classified"</span>: <span class="hljs-keyword">new</span> sap.ui.model.type.Float(),
        <span class="hljs-string">"idEventReason"</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-string">"eventReasonName"</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-string">"idEventSubReason"</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-string">"eventSubReasonName"</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-string">"idEventLocalReason"</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-string">"eventLocalReasonName"</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-string">"idEquipment"</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-string">"comment"</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-string">"synergiNumber"</span>: <span class="hljs-literal">null</span>
      };
    },

    getDetailData: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getProperty(<span class="hljs-string">'/EventDetailData'</span>);
    },

    getSelectedReasonId: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getProperty(<span class="hljs-string">'/EventDetailData/idEventReason'</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <h2 id="lists-with-reason-codes">Lists with reason codes</h2>

            </div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
    getFilterEventDetails: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getProperty(<span class="hljs-string">'/FilterEventDetails'</span>);
    },

    loadLists: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;

      [[<span class="hljs-string">'/EventReasonList'</span>, <span class="hljs-string">'EventReason'</span>],
       [<span class="hljs-string">'/Lists/EventSubReason'</span>, <span class="hljs-string">'EventSubReason'</span>],
       [<span class="hljs-string">'/EventLocalReasonList'</span>, <span class="hljs-string">'EventLocalReason'</span>, <span class="hljs-number">8</span>]
      ].forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">a</span>)</span>{
        <span class="hljs-keyword">var</span> params = {};
        params[<span class="hljs-string">"Param.1"</span>] = a[<span class="hljs-number">1</span>];
        <span class="hljs-keyword">if</span> (a[<span class="hljs-number">2</span>]) {
          params[<span class="hljs-string">"Param.2"</span>] = a[<span class="hljs-number">2</span>];
        }
        <span class="hljs-keyword">var</span> done = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">res</span>) </span>{
          self.setProperty(a[<span class="hljs-number">0</span>], res);
        };
        Common.xhr(<span class="hljs-string">'getLists'</span>, <span class="hljs-string">'GET'</span>, params, done);
      });
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <h2 id="model-helpers">Model helpers</h2>

            </div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
    getMaxEndTimeForEventDetailInCurrentShift: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">idEvent, idShiftData</span>) </span>{
      <span class="hljs-keyword">var</span> aDetails = <span class="hljs-keyword">this</span>.getProperty(<span class="hljs-string">'/EventDetails'</span>);
      <span class="hljs-keyword">var</span> oEndTime = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-number">0</span>);

      <span class="hljs-keyword">if</span> (aDetails) {
        aDetails.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">el</span>) </span>{
          <span class="hljs-keyword">if</span> (el.idEvent === idEvent &amp;&amp; el.idShiftData === idShiftData) {
            oEndTime = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-built_in">Math</span>.max(el.timeEndISO, oEndTime));
          }
        });
      }

      <span class="hljs-keyword">return</span> oEndTime;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <h2 id="misc-stuf">Misc stuf</h2>

            </div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
    changeOpenAjaxCalls: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">i</span>)</span>{
      <span class="hljs-keyword">this</span>.setProperty(<span class="hljs-string">'/CntOpenAjaxCalls'</span>, <span class="hljs-keyword">this</span>.getProperty(<span class="hljs-string">'/CntOpenAjaxCalls'</span>) + i);
    },

    getOpenAjaxCalls: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
      <span class="hljs-keyword">this</span>.getProperty(<span class="hljs-string">'/CntOpenAjaxCalls'</span>);
    }

  });

});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
